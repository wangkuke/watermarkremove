<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI去除水印 - 智能图片水印清除工具</title>
    <meta name="description" content="AI去除水印：在线智能去除图片水印，支持批量处理，保护您的图片版权。快速、安全、高效的水印清除工具。">
    <meta name="keywords" content="AI去除水印, 图片去水印, 智能去水印, 在线去水印, 水印清除工具, 批量去水印, 图片版权保护">
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://docs.opencv.org/4.9.0/opencv.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next/23.10.0/i18next.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next-http-backend/3.0.2/i18nextHttpBackend.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next-browser-languagedetector/7.0.0/i18nextBrowserLanguageDetector.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.7);
            -webkit-backdrop-filter: blur(10px);
                    backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 28px 0 rgba(31, 38, 135, 0.2);
        }
        .blob {
            position: absolute;
            background: linear-gradient(135deg, #4299e1 0%, #9f7aea 100%);
            filter: blur(60px);
            opacity: 0.3;
            border-radius: 50%;
            animation: blob-movement 15s infinite linear;
            z-index: -2;
        }
        @keyframes blob-movement {
            0% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(5%, -10%) scale(1.3); }
            66% { transform: translate(-15%, 5%) scale(0.9); }
            100% { transform: translate(0, 0) scale(1); }
        }
        .highlight-text {
            position: relative;
            display: inline-block;
        }
        .highlight-text::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background-color: rgba(99, 102, 241, 0.2);
            z-index: -1;
        }
        .bg-gradient-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
        .shadow-glow {
            box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.5);
            }
            .canvas-container {
                /* 修改为更灵活的设置，不再使用固定的宽高比 */
                min-height: 400px;
                max-height: 800px;
                height: auto;
                overflow: hidden;
                position: relative;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .mask-drawing {
                cursor: crosshair;
            }
        .premium-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #FAAD14;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-bottom-left-radius: 0.5rem;
        }
        .warning {
            background-color: #FAAD14;
        }
        .success {
            background-color: #00B42A;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-800">
    <div class="blob w-96 h-96 top-0 left-0"></div>
    <div class="blob w-80 h-80 bottom-0 right-0"></div>

    <!-- 导航栏 -->
    <header class="glassmorphism sticky top-0 z-50 p-4">
        <div class="container mx-auto flex items-center justify-between">
            <div class="text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 text-transparent bg-clip-text">
                <i class="fa fa-tint mr-2"></i><span data-i18n="header_title">AI去除水印</span>
            </div>
            <nav class="nav">
                <ul class="nav-list flex items-center space-x-4">
                    <li class="nav-item">
                        <select id="language-switcher" class="px-3 py-1.5 rounded-lg border border-gray-300 bg-white text-gray-700" onchange="changeLanguage(this.value)">
                            <option value="zh" data-i18n="lang_zh">中文</option>
                            <option value="en" data-i18n="lang_en">English</option>
                            <option value="ko" data-i18n="lang_ko">한국어</option>
                            <option value="hi" data-i18n="lang_hi">हिन्दी</option>
                        </select>
                    </li>
                    <li class="nav-item" id="google-login-item">
                        <!-- Google 登录按钮（自定义样式） -->
                        <button id="custom-google-login-button" class="px-4 py-2 bg-gradient-primary text-white rounded-lg hover:opacity-90 transition-opacity flex items-center">
                             <span data-i18n="header_login">登录</span>
                        </button>
                    </li>
                    <li class="nav-item hidden" id="user-status-item">
                        <div id="user-status-container" class="flex items-center space-x-2 bg-gray-100 p-2 rounded-lg relative">
                            <div id="user-icon" class="w-8 h-8 rounded-full cursor-pointer flex items-center justify-center bg-indigo-100 text-indigo-600" title="点击查看会员信息" aria-label="User">&#128100;</div>
                            <span id="user-name" class="text-gray-800 font-medium cursor-pointer hover:underline"></span>
                            <button id="sign-out-button" class="px-3 py-1.5 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700 transition-colors" data-i18n="header_logout">
                                退出
                            </button>
                            <div id="membership-dropdown" class="absolute top-full right-0 mt-2 w-64 bg-white shadow-lg rounded-lg p-4 z-50 border border-gray-200 hidden">
                                <div class="flex flex-col space-y-3">
                                    <div class="font-medium text-gray-800" data-i18n="membership_details">会员详情</div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600" data-i18n="membership_status">会员状态:</span>
                                        <span id="membership-level" class="font-medium text-blue-600" data-i18n="membership_free_user">免费用户</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600" data-i18n="membership_remaining">剩余时间:</span>
                                        <span id="membership-remaining" class="font-medium text-green-600">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600" data-i18n="today_processed">今日已处理:</span>
                                        <span id="processed-today" class="font-medium text-purple-600">0/20张</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto py-8 px-4">
        <section class="max-w-6xl mx-auto">
            <!-- 介绍卡片 -->
            <div class="glassmorphism p-6 mb-8">
                <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-gray-800 mb-4" data-i18n="section_intro_title">AI去除水印</h1>
                <p class="text-gray-600 mb-6" data-i18n="section_intro_description">上传图片，标记水印区域，一键去除。支持批量处理，保护你的图片版权。</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="flex items-start p-4 rounded-lg bg-white/50">
                        <div class="bg-indigo-600/10 p-3 rounded-full mr-4">
                            <i class="fa fa-upload text-indigo-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-1" data-i18n="feature_upload_title">上传图片</h3>
                            <p class="text-sm text-gray-600" data-i18n="feature_upload_description">支持JPG、PNG、WEBP等多种格式</p>
                        </div>
                    </div>
                    <div class="flex items-start p-4 rounded-lg bg-white/50">
                        <div class="bg-indigo-600/10 p-3 rounded-full mr-4">
                            <i class="fa fa-pencil text-indigo-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-1" data-i18n="feature_mark_title">标记水印</h3>
                            <p class="text-sm text-gray-600" data-i18n="feature_mark_description">使用画笔工具圈选水印区域</p>
                        </div>
                    </div>
                    <div class="flex items-start p-4 rounded-lg bg-white/50">
                        <div class="bg-indigo-600/10 p-3 rounded-full mr-4">
                            <i class="fa fa-magic text-indigo-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-1" data-i18n="feature_process_title">一键处理</h3>
                            <p class="text-sm text-gray-600" data-i18n="feature_process_description">AI智能算法去除水印痕迹</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 图片处理区域 -->
            <div class="glassmorphism p-6 mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- 左侧：上传和编辑 -->
                    <div class="h-full">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fa fa-image mr-2 text-indigo-600"></i><span data-i18n="section_upload_edit_title">图片上传与编辑</span>
                    </h3>
                    
                    <!-- 上传区域 -->
                    <div id="upload-container" class="mb-6">
                            <div id="drop-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-indigo-500 transition-colors cursor-pointer">
                                <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-3"></i>
                                <p class="text-gray-600 mb-2" data-i18n="upload_drag_drop">拖放图片到此处，或</p>
                                <label class="inline-block px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors cursor-pointer" data-i18n="upload_select_image">
                                选择图片
                                <input type="file" id="file-input" accept="image/*" class="hidden" multiple>
                            </label>
                                <p class="text-xs text-gray-500 mt-3" data-i18n="upload_formats_size">支持 JPG, PNG, WEBP 格式，最大 10MB</p>
                        </div>
                    </div>
                    
                    <!-- 编辑区域 -->
                    <div id="edit-container" class="hidden">
                        <!-- File list for multiple uploads -->
                        <div id="file-list-container" class="mb-4 hidden">
                                <h4 class="text-sm font-medium text-gray-500 mb-2" data-i18n="file_list_title">已上传图片:</h4>
                            <div id="file-list" class="flex space-x-2 overflow-x-auto pb-2">
                                <!-- Thumbnails will be injected here -->
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-3 mb-4">
                                <button id="draw-mask-btn" class="px-3 py-1.5 bg-indigo-600 text-white rounded-lg text-sm flex items-center">
                                <i class="fa fa-pencil mr-1"></i> <span data-i18n="button_mark_watermark">标记水印</span>
                            </button>
                                <button id="clear-mask-btn" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg text-sm flex items-center">
                                <i class="fa fa-eraser mr-1"></i> <span data-i18n="button_clear_mark">清除标记</span>
                            </button>
                                <button id="undo-btn" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg text-sm flex items-center">
                                <i class="fa fa-undo mr-1"></i> <span data-i18n="button_undo">撤销</span>
                            </button>
                                <button id="redo-btn" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg text-sm flex items-center">
                                <i class="fa fa-repeat mr-1"></i> <span data-i18n="button_redo">重做</span>
                            </button>
                            <div class="ml-auto flex items-center">
                                    <label for="brush-size" class="text-sm text-gray-500 mr-2" data-i18n="brush_size_label">画笔大小:</label>
                                <input type="range" id="brush-size" min="5" max="50" value="12" class="w-24">
                                    <span id="brush-size-value" class="text-sm text-gray-500 ml-1">12px</span>
                            </div>
                        </div>
                        
                        <!-- 图片画布 -->
                        <div class="relative">
                            <div class="canvas-container bg-gray-100 rounded-lg overflow-hidden">
                                <canvas id="image-canvas"></canvas>
                                <canvas id="mask-canvas" class="absolute top-0 left-0 pointer-events-none"></canvas>
                            </div>
                            
                            <!-- 加载中状态 -->
                            <div id="loading-overlay" class="absolute inset-0 bg-black/50 flex items-center justify-center hidden rounded-lg">
                                <div class="bg-white p-4 rounded-lg flex items-center">
                                    <div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-indigo-600 mr-3"></div>
                                    <span class="text-gray-800" data-i18n="loading_processing">处理中...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧：结果和下载 -->
                    <div class="h-full">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fa fa-check-circle mr-2 text-indigo-600"></i><span data-i18n="section_result_title">处理结果</span>
                    </h3>
                    
                    <!-- 结果预览 -->
                    <div id="result-container" class="mb-6 hidden">
                        <div class="grid grid-cols-1 gap-4 mb-4">
                            <div>
                                    <h4 class="text-sm font-medium text-gray-500 mb-2" data-i18n="result_after_processing">处理后</h4>
                                    <div class="canvas-container bg-gray-100 rounded-lg overflow-hidden">
                                    <canvas id="result-canvas" class="w-full h-full"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 质量评分 -->
                            <div class="bg-gray-100 p-4 rounded-lg mb-4">
                            <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm text-gray-500" data-i18n="quality_score_label">处理质量评分</span>
                                    <span id="quality-score" class="font-medium text-purple-600">85%</span>
                            </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="quality-bar" class="bg-purple-500 h-2 rounded-full" style="width: 85%"></div>
                            </div>
                        </div>
                        
                        <!-- 下载按钮 -->
                        <div class="flex flex-wrap gap-3">
                                <button id="download-preview-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center" data-i18n="button_download_preview">
                                <i class="fa fa-download mr-2"></i> 下载预览图
                            </button>
                                 <button id="download-full-btn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center" data-i18n="button_unlock_hd">
                                <i class="fa fa-unlock-alt mr-2"></i> 解锁高清原图
                            </button>
                                <button id="process-another-btn" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors flex items-center" data-i18n="button_process_another">
                                <i class="fa fa-plus mr-2"></i> 处理另一张
                            </button>
                        </div>
                    </div>
                    
                    <!-- 初始状态 -->
                    <div id="empty-result" class="flex flex-col items-center justify-center h-[calc(100%-4rem)]">
                            <div class="text-center p-8 border-2 border-dashed border-gray-300 rounded-lg w-full">
                                <i class="fa fa-picture-o text-5xl text-gray-300 mb-4"></i>
                                <h4 class="text-gray-500 mb-2" data-i18n="empty_result_title">处理结果将显示在这里</h4>
                                <p class="text-sm text-gray-400" data-i18n="empty_result_description">上传图片并标记水印区域后，点击"处理图片"按钮</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 处理按钮 -->
            <div class="mt-8 text-center">
                <button id="process-btn" class="bg-gradient-primary hover:opacity-90 text-white font-bold py-3 px-8 rounded-full shadow-glow transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled data-i18n="button_start_processing">
                    <i class="fa fa-magic mr-2"></i> 开始处理图片
                </button>
            </div>
        </section>
        
        <!-- 功能特点 -->
        <section class="mt-16 max-w-6xl mx-auto">
             <div class="glassmorphism p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-8 text-center" data-i18n="section_why_choose_us">为什么选择我们的水印去除工具</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white/50 p-6 rounded-xl hover:shadow-lg transition-shadow">
                        <div class="w-12 h-12 bg-indigo-600/10 rounded-full flex items-center justify-center mb-4">
                            <i class="fa fa-bolt text-indigo-600 text-xl"></i>
                    </div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2" data-i18n="feature_speed_title">快速处理</h3>
                        <p class="text-gray-600" data-i18n="feature_speed_description">采用先进的AI算法，秒级处理大量图片，无需长时间等待</p>
                </div>
                    <div class="bg-white/50 p-6 rounded-xl hover:shadow-lg transition-shadow">
                        <div class="w-12 h-12 bg-indigo-600/10 rounded-full flex items-center justify-center mb-4">
                            <i class="fa fa-shield text-indigo-600 text-xl"></i>
                    </div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2" data-i18n="feature_security_title">安全可靠</h3>
                        <p class="text-gray-600" data-i18n="feature_security_description">本地处理图片，不上传到服务器，保护您的隐私和版权</p>
                </div>
                    <div class="bg-white/50 p-6 rounded-xl hover:shadow-lg transition-shadow">
                        <div class="w-12 h-12 bg-indigo-600/10 rounded-full flex items-center justify-center mb-4">
                            <i class="fa fa-sliders text-indigo-600 text-xl"></i>
                    </div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2" data-i18n="feature_smart_title">智能操作</h3>
                        <p class="text-gray-600" data-i18n="feature_smart_description">支持手动标记和自动检测，灵活应对各种水印类型</p>
                    </div>
                </div>
            </div>

                        <!-- 会员套餐 -->
            <div class="glassmorphism p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center" data-i18n="pricing_title">选择适合你的会员套餐</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- 7天版 -->
                    <div class="border-2 border-yellow-400 rounded-xl overflow-hidden hover:border-yellow-500/80 transition-all transform hover:-translate-y-1">
                                    <div class="p-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-2" data-i18n="plan_7day_title">7天体验版</h3>
                            <p class="text-gray-600 mb-4" data-i18n="plan_7day_description">快速体验全部功能</p>
                                        <div class="mb-6">
                                <span class="text-4xl font-bold text-gray-800" data-i18n="plan_7day_price_value">$1</span>
                                <span class="text-gray-500" data-i18n="plan_7day_period">/7天</span>
                                        </div>
                                        <ul class="space-y-3 mb-6">
                                            <li class="flex items-start">
                                    <i class="fa fa-check text-green-500 mt-1 mr-2"></i>
                                                <span data-i18n="plan_7day_feature1">单张/批量图片处理</span>
                                            </li>
                                            <li class="flex items-start">
                                    <i class="fa fa-check text-green-500 mt-1 mr-2"></i>
                                                <span data-i18n="plan_7day_feature2">高级水印去除算法</span>
                                            </li>
                                            <li class="flex items-start">
                                    <i class="fa fa-check text-green-500 mt-1 mr-2"></i>
                                                <span data-i18n="plan_7day_feature3">每日10张批量处理</span>
                                            </li>
                                <li class="flex items-start text-gray-400">
                                                <i class="fa fa-times mt-1 mr-2"></i>
                                                <span data-i18n="plan_7day_feature4">高清导出(2K)</span>
                                            </li>
                                <li class="flex items-start text-gray-400">
                                                <i class="fa fa-times mt-1 mr-2"></i>
                                                <span data-i18n="plan_7day_feature5">永久使用权限</span>
                                            </li>
                                        </ul>
                            <button id="7day-btn" class="w-full py-2 bg-yellow-400 text-white rounded-lg hover:bg-yellow-500 transition-colors shadow-md" data-i18n="button_buy_now_7day">
                                            立即购买
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 包月版 -->
                    <div class="border-2 border-indigo-500 rounded-xl overflow-hidden hover:border-indigo-600/80 transition-all transform hover:-translate-y-1 relative">
                                    <div class="premium-badge" data-i18n="badge_popular">热门</div>
                                    <div class="p-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-2" data-i18n="plan_monthly_title">包月专业版</h3>
                            <p class="text-gray-600 mb-4" data-i18n="plan_monthly_description">专业人士首选</p>
                                        <div class="mb-6">
                                <span class="text-4xl font-bold text-gray-800" data-i18n="plan_monthly_price_value">$9.9</span>
                                <span class="text-gray-500" data-i18n="plan_monthly_period">/月</span>
                                        </div>
                                        <ul class="space-y-3 mb-6">
                                            <li class="flex items-start">
                                    <i class="fa fa-check text-green-500 mt-1 mr-2"></i>
                                                <span data-i18n="plan_monthly_feature1">单张/批量图片处理</span>
                                            </li>
                                            <li class="flex items-start">
                                    <i class="fa fa-check text-green-500 mt-1 mr-2"></i>
                                                <span data-i18n="plan_monthly_feature2">高级水印去除算法</span>
                                            </li>
                                            <li class="flex items-start">
                                    <i class="fa fa-check text-green-500 mt-1 mr-2"></i>
                                                <span data-i18n="plan_monthly_feature3">每日50张批量处理</span>
                                            </li>
                                            <li class="flex items-start">
                                    <i class="fa fa-check text-green-500 mt-1 mr-2"></i>
                                                <span data-i18n="plan_monthly_feature4">高清导出(2K)</span>
                                            </li>
                                <li class="flex items-start text-gray-400">
                                                <i class="fa fa-times mt-1 mr-2"></i>
                                                <span data-i18n="plan_monthly_feature5">永久使用权限</span>
                                            </li>
                                        </ul>
                            <button id="monthly-btn" class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow-md" data-i18n="button_buy_now_monthly">
                                            立即购买
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 终身版 -->
                    <div class="border-2 border-green-500 rounded-xl overflow-hidden hover:border-green-600/80 transition-all transform hover:-translate-y-1 relative">
                                    <div class="premium-badge" data-i18n="badge_great_value">超值</div>
                                    <div class="p-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-2" data-i18n="plan_lifetime_title">终身免费版</h3>
                            <p class="text-gray-600 mb-4" data-i18n="plan_lifetime_description">一次购买，永久使用</p>
                                        <div class="mb-6">
                                <span class="text-4xl font-bold text-gray-800" data-i18n="plan_lifetime_price_value">$29.9</span>
                                <span class="text-gray-500" data-i18n="plan_lifetime_period">/终身</span>
                                        </div>
                                        <ul class="space-y-3 mb-6">
                                            <li class="flex items-start">
                                    <i class="fa fa-check text-green-500 mt-1 mr-2"></i>
                                                <span data-i18n="plan_lifetime_feature1">单张/批量图片处理</span>
                                            </li>
                                            <li class="flex items-start">
                                    <i class="fa fa-check text-green-500 mt-1 mr-2"></i>
                                                <span data-i18n="plan_lifetime_feature2">高级水印去除算法</span>
                                            </li>
                                            <li class="flex items-start">
                                    <i class="fa fa-check text-green-500 mt-1 mr-2"></i>
                                                <span data-i18n="plan_lifetime_feature3">无限制批量处理</span>
                                            </li>
                                            <li class="flex items-start">
                                    <i class="fa fa-check text-green-500 mt-1 mr-2"></i>
                                                <span data-i18n="plan_lifetime_feature4">高清导出(4K)</span>
                                            </li>
                                            <li class="flex items-start">
                                    <i class="fa fa-check text-green-500 mt-1 mr-2"></i>
                                                <span data-i18n="plan_lifetime_feature5">永久使用权限</span>
                                            </li>
                                        </ul>
                            <button id="lifetime-btn" class="w-full py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors shadow-md" data-i18n="button_buy_now_lifetime">
                                            立即购买
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
        </section>
    </main>

    <!-- JavaScript -->
    <script>
        let client = null; // Google OAuth 客户端实例

        // 翻译内容更新函数，需要定义在全局作用域中
        function updateContent() {
            console.log('updateContent 函数被调用');
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                const options = {};
                // 如果有嵌套的i18n属性，例如 data-i18n-placeholder
                for (let i = 0; i < element.attributes.length; i++) {
                    const attr = element.attributes[i];
                    if (attr.name.startsWith('data-i18n-')) {
                        const optionKey = attr.name.substring(10); // remove 'data-i18n-'
                        options[optionKey] = true; // Use boolean for simplicity for now, can be extended
                    }
                }

                if (options.placeholder) {
                    element.placeholder = i18next.t(key);
                } else {
                    element.textContent = i18next.t(key);
                }
            });

            // 更新动态内容，如画笔大小值
            const brushSizeValue = document.getElementById('brush-size-value');
            const brushSizeSlider = document.getElementById('brush-size');
            if (brushSizeValue && brushSizeSlider) {
                brushSizeValue.textContent = `${brushSizeSlider.value}px`;
            }

            // 更新警报信息，确保翻译正确传递变量
            window.t = i18next.t; // Make t function globally available for alerts
        }
        
        // 会员级别权限定义
        const membershipLevels = {
            none: {
                name: "membership_free_user",  // 修改为翻译键
                hdExportLimit: 0, // 每日高清导出数量限制
                resolution: "预览", // 分辨率限制
                canDownloadHD: false, // 是否可下载高清
                description: "基础功能"
            },
            trial: {
                name: "plan_7day_title",  // 修改为翻译键
                hdExportLimit: 10, // 改为高清导出限制
                resolution: "2K",
                canDownloadHD: true,
                description: "全功能7天体验"
            },
            monthly: {
                name: "plan_monthly_title",  // 修改为翻译键
                hdExportLimit: 50, // 改为高清导出限制
                resolution: "2K",
                canDownloadHD: true,
                description: "专业人士首选"
            },
            lifetime: {
                name: "plan_lifetime_title",  // 修改为翻译键
                hdExportLimit: Infinity, // 改为高清导出限制
                resolution: "4K",
                canDownloadHD: true,
                description: "永久高级权限"
            }
        };
        
        // 获取用户当前会员级别
        function getUserMembershipLevel(user) {
            if (!user) return membershipLevels.none;
            
            // 检查会员是否过期
            if (user.membershipEnd) {
                const endDate = new Date(user.membershipEnd);
                const now = new Date();
                if (endDate <= now) {
                    return membershipLevels.none; // 会员已过期
                }
            } else {
                return membershipLevels.none; // 无会员信息
            }
            
            // 根据会员类型返回对应权限
            if (user.membershipType === 'trial') return membershipLevels.trial;
            if (user.membershipType === 'monthly') return membershipLevels.monthly;
            if (user.membershipType === 'lifetime') return membershipLevels.lifetime;
            
            // 默认为基础会员
            return membershipLevels.none;
        }
        
        // 检查用户是否有权限执行特定操作
        function checkUserPermission(operationType) {
            const user = JSON.parse(localStorage.getItem('loggedInUser'));
            const membership = getUserMembershipLevel(user);
            
            switch(operationType) {
                case 'downloadHD':
                    if (!membership.canDownloadHD) {
                        return false;
                    }
                    // 检查今日已导出高清图片数量是否超过限制
                    const hdExportedToday = parseInt(localStorage.getItem('hdExportedToday') || '0');
                    return hdExportedToday < membership.hdExportLimit;
                default:
                    return true; // 默认允许基础操作，包括处理图片和导出预览图
            }
        }
        
        // 记录用户处理图片的数量
        function recordImageProcessed() {
            // 获取今天的日期（仅年月日，不含时间）
            const today = new Date().toISOString().split('T')[0];
            const lastProcessDate = localStorage.getItem('lastProcessDate');
            
            // 如果日期变更，重置计数
            if (lastProcessDate !== today) {
                localStorage.setItem('processedToday', '1');
                localStorage.setItem('lastProcessDate', today);
            } else {
                // 增加计数
                const processedToday = parseInt(localStorage.getItem('processedToday') || '0');
                localStorage.setItem('processedToday', (processedToday + 1).toString());
            }
        }
        
        // 记录用户高清图片导出数量
        function recordHDImageExported() {
            const today = new Date().toISOString().split('T')[0];
            const lastHDExportDate = localStorage.getItem('lastHDExportDate');

            if (lastHDExportDate !== today) {
                // 如果是新的一天，重置计数
                localStorage.setItem('hdExportedToday', '1');
                localStorage.setItem('lastHDExportDate', today);
            } else {
                // 否则，增加计数
                const hdExportedToday = parseInt(localStorage.getItem('hdExportedToday') || '0');
                localStorage.setItem('hdExportedToday', (hdExportedToday + 1).toString());
            }

            // 导出后立即更新UI显示
            updateLoginStatusUI();
        }
        
        // Creem支付集成
        async function handleCreemPayment(plan) {
            // 检查用户是否登录
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            if (!loggedInUser) {
                alert(i18next.t('alert_login_to_purchase', '请先登录再进行购买'));
                return;
            }
            
            // 根据套餐设置价格和产品ID
            let productId, amount, currency = 'USD';
            
            switch(plan) {
                case '7天体验版':
                    productId = 'trial_7day'; // 这里需要替换为您在Creem后台创建的实际产品ID
                    amount = 100; // $1.00
                    
                    // 检查用户是否已购买过体验会员
                    if (loggedInUser.hasPurchasedTrial) {
                        alert(i18next.t('alert_trial_once', '体验会员仅限购买一次'));
                        return;
                    }
                    
                    // 7天体验版直接模拟购买成功
                    try {
                        // 显示加载状态
                        const buyButton = document.getElementById('7day-btn');
                        const originalText = buyButton.textContent;
                        buyButton.disabled = true;
                        buyButton.textContent = i18next.t('button_processing', '处理中...');
                        
                        // 模拟处理延迟
                        setTimeout(() => {
                            // 更新用户会员信息
                            loggedInUser.membershipType = 'trial';
                            loggedInUser.hasPurchasedTrial = true;
                            loggedInUser.membershipEnd = new Date(new Date().getTime() + (7 * 24 * 60 * 60 * 1000)).toISOString();
                            
                            // 保存更新后的用户信息
                            localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
                            
                            // 更新UI
                            updateLoginStatusUI();
                            
                            // 恢复按钮状态
                            buyButton.disabled = false;
                            buyButton.textContent = originalText;
                            
                            // 显示成功消息
                            alert(i18next.t('alert_purchase_success', { plan: plan }));
                        }, 1000);
                    } catch (error) {
                        console.error('处理错误:', error);
                        alert(i18next.t('alert_payment_error', '处理出错，请稍后再试'));
                        
                        // 恢复按钮状态
                        const buyButton = document.getElementById('7day-btn');
                        buyButton.disabled = false;
                        buyButton.textContent = originalText;
                    }
                    
                    // 直接返回，不继续执行Creem支付流程
                    return;
                    
                case '包月专业版':
                    productId = 'prod_3vgttjMsj7N8o9WHqjRBYa'; // 这里需要替换为您在Creem后台创建的实际产品ID
                    amount = 990; // $9.90
                    break;
                case '终身免费版':
                    productId = 'prod_6bW2d17x1FnkF9IAMAF0dF'; // 这里需要替换为您在Creem后台创建的实际产品ID
                    amount = 2990; // $29.90
                    break;
                default:
                    alert('未知的套餐类型');
                    return;
            }
            
            try {
                // 显示加载状态
                const buyButton = document.querySelector(`#${plan === '包月专业版' ? 'monthly-btn' : 'lifetime-btn'}`);
                const originalText = buyButton.textContent;
                buyButton.disabled = true;
                buyButton.textContent = i18next.t('button_processing', '处理中...');
                
                // 调用Creem API创建结账会话
                // 注意：实际生产环境中，应该从您的后端服务器调用此API，而不是从前端直接调用
                // 这里仅作为演示，实际实现时应该通过您自己的后端API进行
                const response = await fetch('https://api.creem.io/v1/checkouts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': 'creem_2h0v1uitjs4Zf4LiL5hhmv' // 替换为您的Creem API密钥
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        request_id: `user_${loggedInUser.name}_${Date.now()}`, // 创建唯一请求ID
                        customer: {
                            email: loggedInUser.email || 'user@example.com' // 如果有用户邮箱则使用，否则使用默认值
                        },
                        metadata: {
                            userId: loggedInUser.name,
                            planType: plan
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error('支付请求失败');
                }
                
                const data = await response.json();
                
                // 保存支付会话信息到localStorage，以便稍后验证
                localStorage.setItem('pendingPayment', JSON.stringify({
                    checkout_id: data.id,
                    plan: plan,
                    timestamp: Date.now()
                }));
                
                // 重定向到Creem支付页面
                window.location.href = data.checkout_url;
                
            } catch (error) {
                console.error('支付处理错误:', error);
                alert(i18next.t('alert_payment_error', '支付处理出错，请稍后再试'));
                
                // 恢复按钮状态
                const buyButton = document.querySelector(`#${plan === '包月专业版' ? 'monthly-btn' : 'lifetime-btn'}`);
                buyButton.disabled = false;
                buyButton.textContent = originalText;
            }
        }
        
        // 检查支付状态
        function checkPaymentStatus() {
            const pendingPayment = JSON.parse(localStorage.getItem('pendingPayment'));
            
            // 如果有待处理的支付且URL中包含成功参数
            if (pendingPayment && window.location.search.includes('status=success')) {
                const urlParams = new URLSearchParams(window.location.search);
                const checkoutId = urlParams.get('checkout_id');
                
                // 验证结账ID是否匹配
                if (checkoutId === pendingPayment.checkout_id) {
                    // 清除待处理支付
                    localStorage.removeItem('pendingPayment');
                    
                    // 更新用户会员信息
                    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
                    if (loggedInUser) {
                        // 根据套餐类型设置会员信息
                        switch(pendingPayment.plan) {
                            case '7天体验版':
                                loggedInUser.membershipType = 'trial';
                                loggedInUser.hasPurchasedTrial = true;
                                loggedInUser.membershipEnd = new Date(new Date().getTime() + (7 * 24 * 60 * 60 * 1000)).toISOString();
                                break;
                            case '包月专业版':
                                loggedInUser.membershipType = 'monthly';
                                loggedInUser.membershipEnd = new Date(new Date().getTime() + (30 * 24 * 60 * 60 * 1000)).toISOString();
                                break;
                            case '终身免费版':
                                loggedInUser.membershipType = 'lifetime';
                                loggedInUser.membershipEnd = new Date(new Date().getTime() + (100 * 365 * 24 * 60 * 60 * 1000)).toISOString();
                                break;
                        }
                        
                        // 保存更新后的用户信息
                        localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
                        
                        // 更新UI
                        updateLoginStatusUI();
                        
                        // 显示成功消息
                        setTimeout(() => {
                            alert(i18next.t('alert_purchase_success', { plan: pendingPayment.plan }));
                        }, 500);
                    }
                }
            }
        }
        
        // 添加测试函数，用于手动模拟用户登录（可在控制台调用）
        function simulateLogin(membershipType = 'none') {
            // 计算会员到期时间
            let expiryDate;
            switch(membershipType) {
                case 'trial':
                    expiryDate = new Date(new Date().getTime() + (7 * 24 * 60 * 60 * 1000)); // 7天后
                    break;
                case 'monthly':
                    expiryDate = new Date(new Date().getTime() + (30 * 24 * 60 * 60 * 1000)); // 30天后
                    break;
                case 'lifetime':
                    expiryDate = new Date(new Date().getTime() + (100 * 365 * 24 * 60 * 60 * 1000)); // 100年后
                    break;
                default:
                    expiryDate = null; // 无会员
            }
            
            const simulatedProfile = {
                name: "普通用户", // 使用中文
                membershipType: membershipType,
                membershipEnd: expiryDate ? expiryDate.toISOString() : null
            };
            
            // 确保JSON.stringify正确处理中文
            const profileJson = JSON.stringify(simulatedProfile);
            console.log("存储的用户信息:", profileJson);
            localStorage.setItem('loggedInUser', profileJson);
            
            // 更新isPremiumUser全局变量
            isPremiumUser = membershipType !== 'none';
            
            // 刷新页面是最可靠的方法
            alert(`模拟${membershipLevels[membershipType].name}登录成功，页面将刷新以更新状态`);
            location.reload();
            return "登录成功";
        }
        
        // 添加测试函数，用于查看和测试下拉菜单
        function testDropdown() {
            const dropdown = document.getElementById('membership-dropdown');
            dropdown.classList.toggle('hidden');
            console.log("下拉菜单可见性已切换");
            return dropdown.classList.contains('hidden') ? "下拉菜单已隐藏" : "下拉菜单已显示";
        }

        // JWT解析函数 (用于从Google ID Token中获取用户信息)
        function parseJwt (token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // Google 授权回调函数 (接收授权码)
        function handleAuthCodeResponse(response) {
            console.log("Authorization Code: " + response.code);
            // 在实际应用中，您通常会将此 `response.code` 发送到后端服务器
            // 进行令牌交换，获取 access_token 和 id_token。
            // 为了本前端演示，我们在此处模拟一个成功的用户登录来更新UI。
            // !!! 警告：此方法在生产环境中不安全，ID Token 应该始终在后端进行验证。!!!
            
            // 创建与谷歌用户信息格式一致的模拟用户
            const simulatedProfile = {
                name: "普通用户", // 使用容易辨识的名称
                email: "auth@example.com",
                picture: "",
                membershipEnd: new Date(new Date().getTime() + (30 * 24 * 60 * 60 * 1000)).toISOString() // 模拟30天后的会员结束日期
            };
            
            // 存储用户信息
            localStorage.setItem('loggedInUser', JSON.stringify(simulatedProfile));
            console.log("已存储授权码用户信息:", JSON.stringify(simulatedProfile));
            
            // 更新UI
            updateLoginStatusUI();
            
            // 可选：刷新页面以确保所有状态正确
            setTimeout(() => {
                location.reload();
            }, 500);
        }

        // Google 登录回调函数 (接收ID Token)
        function handleCredentialResponse(response) {
            console.log("Encoded ID Token: " + response.credential);
            const profile = parseJwt(response.credential);
            console.log("Google User Profile:", profile);

            // 确保用户名正确提取
            const userProfile = {
                name: profile.name || "Google User", // 确保有一个默认值
                email: profile.email,
                picture: profile.picture,
                membershipEnd: new Date(new Date().getTime() + (30 * 24 * 60 * 60 * 1000)).toISOString() // 模拟30天后的会员结束日期
            };
            
            // 确保将谷歌用户信息正确存储
            localStorage.setItem('loggedInUser', JSON.stringify(userProfile));
            console.log("已存储谷歌用户信息:", JSON.stringify(userProfile));
            
            // 更新UI显示登录状态
            updateLoginStatusUI();
        }

        // 更新登录状态UI的函数
        function updateLoginStatusUI() {
            const user = JSON.parse(localStorage.getItem('loggedInUser'));
            const userStatusContainer = document.getElementById('user-status-container');
            // 修改为正确的登录按钮容器ID
            const googleLoginItem = document.getElementById('google-login-item');
            const userStatusItem = document.getElementById('user-status-item');
            const userIcon = document.getElementById('user-icon');
            const userName = document.getElementById('user-name');
            const membershipDropdown = document.getElementById('membership-dropdown');
            
            console.log("更新登录状态UI", user ? user.name : "未登录");

            if (user) {
                // 用户已登录
                if (googleLoginItem) googleLoginItem.classList.add('hidden');
                if (userStatusItem) userStatusItem.classList.remove('hidden');
                if (userIcon) userIcon.src = user.picture || './assets/user-icon.png';
                if (userName) userName.textContent = user.name || '用户';
                
                // 确保为用户图标和用户名添加点击事件
                if (userIcon && !userIcon.hasAttribute('data-has-click-listener')) {
                    console.log("为用户图标添加点击事件");
                    userIcon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        console.log("用户图标被点击");
                        toggleDropdown();
                    });
                    userIcon.setAttribute('data-has-click-listener', 'true');
                    userIcon.classList.add('cursor-pointer');
                }
                
                if (userName && !userName.hasAttribute('data-has-click-listener')) {
                    console.log("为用户名添加点击事件");
                    userName.addEventListener('click', function(e) {
                        e.stopPropagation();
                        console.log("用户名被点击");
                        toggleDropdown();
                    });
                    userName.setAttribute('data-has-click-listener', 'true');
                    userName.classList.add('cursor-pointer');
                }
                
                // 添加点击其他区域关闭下拉菜单的事件
                if (!document.body.hasAttribute('data-has-click-listener')) {
                    console.log("为body添加点击事件以关闭下拉菜单");
                    document.body.addEventListener('click', function() {
                        console.log("点击了页面其他区域");
                        if (membershipDropdown && !membershipDropdown.classList.contains('hidden')) {
                            console.log("关闭下拉菜单");
                            membershipDropdown.classList.add('hidden');
                        }
                    });
                    document.body.setAttribute('data-has-click-listener', 'true');
                }
                
                // 为退出按钮添加事件监听
                const signOutButton = document.getElementById('sign-out-button');
                if (signOutButton && !signOutButton.hasAttribute('data-has-click-listener')) {
                    console.log("为退出按钮添加点击事件");
                    signOutButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        console.log("退出按钮被点击");
                        signOut();
                    });
                    signOutButton.setAttribute('data-has-click-listener', 'true');
                }
                
                // 更新下拉菜单内容
                if (membershipDropdown) {
                    updateMembershipInfo(user, membershipDropdown);
                    updateI18nForDropdown(); // 确保应用当前语言
                }
            } else {
                // 用户未登录
                if (googleLoginItem) googleLoginItem.classList.remove('hidden');
                if (userStatusItem) userStatusItem.classList.add('hidden');
                if (membershipDropdown) membershipDropdown.classList.add('hidden');
            }
        }

        // 切换下拉菜单显示状态
        function toggleDropdown() {
            const membershipDropdown = document.getElementById('membership-dropdown');
            console.log("toggleDropdown被调用，当前状态:", membershipDropdown.classList.contains('hidden') ? "隐藏" : "显示");
            
            if (membershipDropdown.classList.contains('hidden')) {
                // 如果下拉菜单隐藏，则显示并更新信息
                membershipDropdown.classList.remove('hidden');
                console.log("下拉菜单已显示");
                
                // 更新下拉菜单内容
                const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
                if (loggedInUser) {
                    updateMembershipInfo(loggedInUser, membershipDropdown);
                }
                
                // 确保应用当前语言
                updateI18nForDropdown();
            } else {
                // 如果下拉菜单显示，则隐藏
                membershipDropdown.classList.add('hidden');
                console.log("下拉菜单已隐藏");
            }
        }

        // 为下拉菜单中的元素专门更新i18n
        function updateI18nForDropdown() {
            const membershipDropdown = document.getElementById('membership-dropdown');
            if (!membershipDropdown) return;
            
            // 获取下拉菜单中的所有带有data-i18n属性的元素
            const i18nElements = membershipDropdown.querySelectorAll('[data-i18n]');
            i18nElements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                // 检查是否为特殊元素，不覆盖一些动态内容
                if (element.id !== 'membership-remaining' && 
                    element.id !== 'processed-today') {
                    element.textContent = i18next.t(key);
                }
            });
            
            // 更新会员等级显示
            const membershipLevel = document.getElementById('membership-level');
            if (membershipLevel) {
                const user = JSON.parse(localStorage.getItem('loggedInUser'));
                if (user) {
                    const membership = getUserMembershipLevel(user);
                    if (membership && membership.name) {
                        membershipLevel.textContent = i18next.t(membership.name);
                    } else {
                        membershipLevel.textContent = i18next.t('membership_free_user');
                    }
                } else {
                    membershipLevel.textContent = i18next.t('membership_free_user');
                }
            }
        }

        // 退出登录函数
        function signOut() {
            console.log("正在登出...");
            localStorage.removeItem('loggedInUser');
            updateLoginStatusUI();
            // 刷新页面以确保所有状态被重置
            setTimeout(() => {
                location.reload();
            }, 500);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // i18next 初始化
            i18next
                .use(i18nextHttpBackend)
                .use(i18nextBrowserLanguageDetector) // 重新启用语言检测器
                .init({
                    // lng: 'en', // 移除强制设置，让检测器工作
                    fallbackLng: 'en',
                    debug: true,
                    load: 'languageOnly', // 关键：只加载主语言代码，如 zh 而不是 zh-CN
                    backend: {
                        loadPath: 'locales/{{lng}}/translation.json'
                    },
                    supportedLngs: ['zh', 'en', 'ko', 'hi'], // 明确支持的语言
                    nonExplicitSupportedLngs: true, // 允许 zh-CN 这样的非精确匹配映射到 zh
                    detection: {
                        order: ['queryString', 'cookie', 'navigator'], // 优先顺序：URL参数 -> Cookie -> 浏览器语言
                        // caches: ['localStorage'] // 移除缓存，避免记住旧偏好
                        // lookupFromPath 已经被 backend.load 取代，可以移除
                    }
                }, function(err, t) {
                    if (err) {
                        console.error("i18next初始化失败:", err);
                    } else {
                        console.log("i18next初始化成功，当前语言:", i18next.language);
                    }
                    // 初始化完成后，开始翻译页面
                    updateContent();
                    updateLoginStatusUI(); // 在i18next初始化完成后更新登录状态UI
                    
                    // 检查URL参数，处理支付返回
                    if (window.location.search) {
                        checkPaymentStatus();
                    }
                });

            // 语言切换功能 (暂时只用于测试，后续会添加UI)
            window.changeLanguage = (lng) => {
                console.log(`changeLanguage 函数被调用，语言为: ${lng}`);
                i18next.changeLanguage(lng, (err, t) => {
                    if (err) return console.log('something went wrong loading', err);
                    updateContent();
                    
                    // 如果下拉菜单是可见的，更新其内容
                    const membershipDropdown = document.getElementById('membership-dropdown');
                    if (membershipDropdown && !membershipDropdown.classList.contains('hidden')) {
                        updateI18nForDropdown();
                    }
                });
            };
            
            // 全局变量
            let currentFiles = [];
            let activeFileIndex = -1;
            let maskHistory = []; // [file1_history, file2_history, ...]
            let historyIndex = []; // [file1_index, file2_index, ...]
        let isDrawing = false;
            let drawingEnabled = false;
            let lastPos;
            let isPremiumUser = false; // 新增：用户是否为付费用户
            let originalImageObject = null; // 新增：保存原始图片对象

            // DOM 元素
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('file-input');
            const uploadContainer = document.getElementById('upload-container');
            const editContainer = document.getElementById('edit-container');
            const fileListContainer = document.getElementById('file-list-container');
            const fileList = document.getElementById('file-list');
            
            const imageCanvas = document.getElementById('image-canvas');
            const maskCanvas = document.getElementById('mask-canvas');
            const resultCanvas = document.getElementById('result-canvas');
            const imageCtx = imageCanvas.getContext('2d', { willReadFrequently: true });
            const maskCtx = maskCanvas.getContext('2d', { willReadFrequently: true });
            const resultCtx = resultCanvas.getContext('2d', { willReadFrequently: true });

            const drawMaskBtn = document.getElementById('draw-mask-btn');
            const clearMaskBtn = document.getElementById('clear-mask-btn');
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            const brushSizeSlider = document.getElementById('brush-size');
            const brushSizeValue = document.getElementById('brush-size-value');
            
            const processBtn = document.getElementById('process-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            
            const resultContainer = document.getElementById('result-container');
            const emptyResult = document.getElementById('empty-result');
            const qualityScore = document.getElementById('quality-score');
            const qualityBar = document.getElementById('quality-bar');

            const downloadPreviewBtn = document.getElementById('download-preview-btn');
            const downloadFullBtn = document.getElementById('download-full-btn');
            const processAnotherBtn = document.getElementById('process-another-btn');

            function initialize() {
                setupDragAndDrop();
                setupButtons();
                setupCanvas();
                resetToInitial();
                // 确保初始画笔大小显示正确
                brushSizeValue.textContent = `${brushSizeSlider.value}px`;
            }

            function setupDragAndDrop() {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.add('border-indigo-500'), false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.remove('border-indigo-500'), false);
                });

                dropArea.addEventListener('click', () => {
                    fileInput.value = ''; // 关键：在打开文件选择对话框前清空值
                    fileInput.click();
                });
            dropArea.addEventListener('drop', handleDrop, false);
            
                // 修改文件输入事件监听
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files.length > 0) {
                        handleFiles(e.target.files);
                    }
                });
            }

            function setupButtons() {
                drawMaskBtn.addEventListener('click', toggleDrawing);
            clearMaskBtn.addEventListener('click', clearMask);
            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);
                brushSizeSlider.addEventListener('input', (e) => {
                    brushSizeValue.textContent = `${e.target.value}px`;
                });
            processBtn.addEventListener('click', processImage);
                processAnotherBtn.addEventListener('click', resetToInitial);
                downloadPreviewBtn.addEventListener('click', () => downloadResult('preview'));
                downloadFullBtn.addEventListener('click', () => downloadResult('full'));
                
                document.getElementById('7day-btn').addEventListener('click', () => purchase('7天体验版'));
                document.getElementById('monthly-btn').addEventListener('click', () => purchase('包月专业版'));
                document.getElementById('lifetime-btn').addEventListener('click', () => purchase('终身免费版'));
            }

            function setupCanvas() {
                const getMousePos = (e) => {
                    const rect = maskCanvas.getBoundingClientRect();
                    // 修正坐标计算，考虑画布的实际尺寸和显示尺寸的比例
                    const scaleX = maskCanvas.width / rect.width;
                    const scaleY = maskCanvas.height / rect.height;
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    
                    return {
                        x: Math.max(0, Math.min(maskCanvas.width, (clientX - rect.left) * scaleX)),
                        y: Math.max(0, Math.min(maskCanvas.height, (clientY - rect.top) * scaleY))
                    };
                };

                const startDrawing = (e) => {
                    if (!drawingEnabled) return;
                    isDrawing = true;
                    lastPos = getMousePos(e);
                };

                const draw = (e) => {
                    if (!isDrawing || !drawingEnabled) return;
                    preventDefaults(e);
                    const currentPos = getMousePos(e);
                    drawOnMask(lastPos, currentPos);
                    lastPos = currentPos;
                };

                const stopDrawing = () => {
                    if (isDrawing) {
                       saveMaskHistory();
                    }
                    isDrawing = false;
                };

            maskCanvas.addEventListener('mousedown', startDrawing);
            maskCanvas.addEventListener('mousemove', draw);
                maskCanvas.addEventListener('mouseup', stopDrawing);
                maskCanvas.addEventListener('mouseleave', stopDrawing);

                maskCanvas.addEventListener('touchstart', startDrawing);
                maskCanvas.addEventListener('touchmove', draw);
                maskCanvas.addEventListener('touchend', stopDrawing);
            }

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function handleDrop(e) {
                handleFiles(e.dataTransfer.files);
            }

        function handleFiles(files) {
            if (!files || files.length === 0) return;
            
            // 显示加载状态
            loadingOverlay.classList.remove('hidden');
            
            const newFiles = Array.from(files).filter(file => {
                const isImage = file.type.startsWith('image/');
                if (!isImage) {
                    alert('请只上传图片文件！');
                    return false;
                }
                return true;
            });
            
            if (newFiles.length === 0) {
                loadingOverlay.classList.add('hidden');
                return;
            }

            // 直接处理文件
            currentFiles = newFiles;
            
            // 初始化空的遮罩历史和索引，以便updateUndoRedoButtons不会报错
            maskHistory = []; 
            historyIndex = [];
            
            uploadContainer.classList.add('hidden');
            editContainer.classList.remove('hidden');
            processBtn.classList.remove('hidden'); // 显示按钮
            processBtn.disabled = true; // 初始禁用按钮
            
            if (currentFiles.length > 1) {
                fileListContainer.classList.remove('hidden');
            } else {
                fileListContainer.classList.add('hidden');
            }
            
            // 先设置激活的文件，这会加载图像并设置画布尺寸
            setActiveFile(0);
            
            // 当图像加载完成后，初始化遮罩历史
            // 使用setTimeout确保setActiveFile中的图像已完全加载
            setTimeout(() => {
                maskHistory = currentFiles.map(() => [createEmptyMaskData()]);
                historyIndex = currentFiles.map(() => 0);
                loadingOverlay.classList.add('hidden'); // 在这里隐藏加载状态
                updateUndoRedoButtons(); // 重新更新按钮状态
            }, 500);
        }

            function renderFileList() {
                fileList.innerHTML = '';
                currentFiles.forEach((file, index) => {
                const thumbContainer = document.createElement('div');
                    thumbContainer.className = `relative p-1 rounded-lg cursor-pointer ${index === activeFileIndex ? 'bg-indigo-200' : ''}`;
                    
                    const thumb = document.createElement('img');
                    thumb.src = URL.createObjectURL(file);
                    thumb.className = 'h-16 w-16 object-cover rounded-md';
                    thumb.alt = i18next.t('thumbnail_alt_text', { fileName: file.name });
                    
                    thumbContainer.appendChild(thumb);
                    thumbContainer.onclick = () => setActiveFile(index);
                    fileList.appendChild(thumbContainer);
                });
            }

            function setActiveFile(index) {
                if (index < 0 || index >= currentFiles.length || activeFileIndex === index) return;
                
                activeFileIndex = index;
                
                // 确保切换到新图片时标记水印功能是关闭的
                drawingEnabled = false;
                drawMaskBtn.classList.remove('bg-indigo-600', 'text-white');
                drawMaskBtn.classList.add('bg-gray-200', 'text-gray-700');
                maskCanvas.classList.remove('mask-drawing');
                maskCanvas.style.pointerEvents = 'none';
                
                const file = currentFiles[index];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        originalImageObject = img; // 保存原始图片对象

                        // 获取容器尺寸
                        const container = imageCanvas.parentElement;
                        const containerWidth = container.clientWidth;
                        const containerHeight = container.clientHeight;
                        
                        // 保持原始图像像素不受压缩
                        const originalWidth = img.width;
                        const originalHeight = img.height;
                        
                        // 计算适合容器的最大尺寸，同时保持宽高比
                        let displayWidth, displayHeight;
                        const imageRatio = originalWidth / originalHeight;
                        
                        // 最大显示比例 - 如果图片特别大，最多显示为原始尺寸的80%
                        const MAX_DISPLAY_RATIO = 0.8;
                        
                        // 计算基于容器尺寸的最大尺寸
                        if (imageRatio > containerWidth / containerHeight) {
                            // 图片更宽，以容器宽度为基准
                            displayWidth = Math.min(containerWidth, originalWidth);
                            displayHeight = displayWidth / imageRatio;
                        } else {
                            // 图片更高，以容器高度为基准
                            displayHeight = Math.min(containerHeight, originalHeight);
                            displayWidth = displayHeight * imageRatio;
                        }
                        
                        // 应用最大显示比例限制
                        const displayRatio = Math.min(
                            displayWidth / originalWidth,
                            displayHeight / originalHeight,
                            MAX_DISPLAY_RATIO
                        );
                        
                        // 使用比例计算最终显示尺寸
                        displayWidth = originalWidth * displayRatio;
                        displayHeight = originalHeight * displayRatio;
                        
                        console.log("Image dimensions:", originalWidth, "x", originalHeight);
                        console.log("Container dimensions:", containerWidth, "x", containerHeight);
                        console.log("Display dimensions:", displayWidth, "x", displayHeight, "ratio:", displayRatio);
                        
                        // 设置画布为原始图像大小，但使用CSS控制显示大小
                        imageCanvas.width = originalWidth;
                        imageCanvas.height = originalHeight;
                        maskCanvas.width = originalWidth;
                        maskCanvas.height = originalHeight;
                        
                        // 设置画布显示样式，使用计算出的确切尺寸
                        // 通过绝对定位和transform使其在flex容器中也居中
                        imageCanvas.style.position = 'absolute';
                        imageCanvas.style.top = '50%';
                        imageCanvas.style.left = '50%';
                        imageCanvas.style.transform = 'translate(-50%, -50%)';
                        imageCanvas.style.width = `${displayWidth}px`;
                        imageCanvas.style.height = `${displayHeight}px`;
                        imageCanvas.style.display = 'block';
                        
                        maskCanvas.style.position = 'absolute';
                        maskCanvas.style.top = '50%';
                        maskCanvas.style.left = '50%';
                        maskCanvas.style.transform = 'translate(-50%, -50%)';
                        maskCanvas.style.width = `${displayWidth}px`;
                        maskCanvas.style.height = `${displayHeight}px`;
                        maskCanvas.style.display = 'block';
                        
                        // 确保mask canvas覆盖image canvas
                        // maskCanvas.style.position = 'absolute'; // 已设置
                        // maskCanvas.style.top = '0'; // 修改为居中
                        // maskCanvas.style.left = '0'; // 修改为居中
                        
                        // 清除并绘制图片（使用原始尺寸）
                        imageCtx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
                        imageCtx.drawImage(img, 0, 0, originalWidth, originalHeight);
                        
                        // 恢复遮罩
                        restoreMask();

                        // 图片加载并绘制完成后，启用处理按钮
                        processBtn.disabled = false;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);

                if (currentFiles.length > 1) {
                    renderFileList();
                }
                updateUndoRedoButtons();
            }
            
            function toggleDrawing() {
                drawingEnabled = !drawingEnabled;
                maskCanvas.classList.toggle('mask-drawing', drawingEnabled);
                maskCanvas.style.pointerEvents = drawingEnabled ? 'auto' : 'none';
                drawMaskBtn.classList.toggle('bg-indigo-600', drawingEnabled);
                drawMaskBtn.classList.toggle('text-white', drawingEnabled);
                drawMaskBtn.classList.toggle('bg-gray-200', !drawingEnabled);
                drawMaskBtn.classList.toggle('text-gray-700', !drawingEnabled);
                
                // 添加状态提示
                console.log("绘图模式已" + (drawingEnabled ? "启用" : "禁用"));
            }
            
            function drawOnMask(from, to) {
                maskCtx.beginPath();
                maskCtx.moveTo(from.x, from.y);
                maskCtx.lineTo(to.x, to.y);
                maskCtx.strokeStyle = 'rgba(239, 68, 68, 0.75)'; // Red with some transparency
                maskCtx.lineWidth = brushSizeSlider.value;
                maskCtx.lineCap = 'round';
                maskCtx.lineJoin = 'round';
                maskCtx.stroke();
            }

        function clearMask() {
            maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
                saveMaskHistory();
            }

            function saveMaskHistory() {
                if (activeFileIndex < 0) return;
                const currentMasks = maskHistory[activeFileIndex];
                const currentIndex = historyIndex[activeFileIndex];

                if (currentIndex < currentMasks.length - 1) {
                    maskHistory[activeFileIndex] = currentMasks.slice(0, currentIndex + 1);
                }

                const newMaskData = maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height);
                maskHistory[activeFileIndex].push(newMaskData);
                historyIndex[activeFileIndex]++;
            updateUndoRedoButtons();
        }
        
            function restoreMask() {
                if (activeFileIndex < 0) return;
                if (!maskHistory[activeFileIndex] || historyIndex[activeFileIndex] === undefined) {
                    console.warn("遮罩历史数据不存在，无法恢复遮罩");
                    return;
                }
                
                const currentMaskData = maskHistory[activeFileIndex][historyIndex[activeFileIndex]];
                if (!currentMaskData) {
                    console.warn("当前遮罩数据不存在，无法恢复遮罩");
                    return;
                }
                
                // 确保遮罩数据尺寸与画布尺寸一致
                if (currentMaskData.width === maskCanvas.width && currentMaskData.height === maskCanvas.height) {
                    maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
                    maskCtx.putImageData(currentMaskData, 0, 0);
                } else {
                    console.warn(`遮罩数据尺寸 (${currentMaskData.width}x${currentMaskData.height}) 与画布尺寸 (${maskCanvas.width}x${maskCanvas.height}) 不一致，创建新的空遮罩`);
                    maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
                    // 如果尺寸不一致，重新创建遮罩历史
                    maskHistory[activeFileIndex] = [createEmptyMaskData()];
                    historyIndex[activeFileIndex] = 0;
                }
            }

            function createEmptyMaskData() {
                // 确保创建的空遮罩数据与当前画布尺寸一致
                if (activeFileIndex >= 0 && maskCanvas.width > 0 && maskCanvas.height > 0) {
                    return maskCtx.createImageData(maskCanvas.width, maskCanvas.height);
                } else {
                    // 如果画布尺寸无效，创建一个默认大小的空遮罩
                    console.warn("创建空遮罩时画布尺寸无效，使用默认尺寸");
                    return maskCtx.createImageData(800, 600);
                }
            }

        function undo() {
                if (activeFileIndex < 0 || historyIndex[activeFileIndex] <= 0) return;
                historyIndex[activeFileIndex]--;
                restoreMask();
                updateUndoRedoButtons();
        }
        
        function redo() {
                if (activeFileIndex < 0 || historyIndex[activeFileIndex] >= maskHistory[activeFileIndex].length - 1) return;
                historyIndex[activeFileIndex]++;
                restoreMask();
                updateUndoRedoButtons();
            }

            function updateUndoRedoButtons() {
                if (activeFileIndex < 0) return;
                
                // 检查maskHistory和historyIndex是否已初始化
                if (!maskHistory || !maskHistory[activeFileIndex] || !historyIndex || historyIndex[activeFileIndex] === undefined) {
                    console.warn("更新撤销/重做按钮时，遮罩历史数据不存在");
                    // 临时禁用按钮直到数据可用
                    if (undoBtn) undoBtn.disabled = true;
                    if (redoBtn) redoBtn.disabled = true;
                    return;
                }
                
                undoBtn.disabled = historyIndex[activeFileIndex] <= 0;
                redoBtn.disabled = historyIndex[activeFileIndex] >= maskHistory[activeFileIndex].length - 1;
            }
        
        function processImage() {
            if(activeFileIndex < 0) return;

            // 检查是否有标记水印
            const maskData = maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height);
            const hasMask = maskData.data.some(pixel => pixel > 0);
            if (!hasMask) {
                alert(i18next.t('alert_mask_first', '请先标记水印区域！'));
                return;
            }

            loadingOverlay.classList.remove('hidden');
            
            // 使用 Promise 包装 OpenCV 处理
            new Promise((resolve, reject) => {
                let src = null, mask = null, dst = null;
                let gray = null, maskGray = null, binaryMask = null, kernel = null, dilatedMask = null;
                let tempCanvas = null, tempCtx = null, tempMaskCanvas = null, tempMaskCtx = null;

                try {
                    // 确保 OpenCV 已加载
                    if (typeof cv === 'undefined' || !cv.Mat) {
                        throw new Error('OpenCV 未加载完成，请稍后重试。');
                    }

                    // 获取原始图片尺寸
                    if (!originalImageObject) {
                        throw new Error('原始图片数据未加载。请重新上传图片。');
                    }
                    const originalWidth = originalImageObject.width;
                    const originalHeight = originalImageObject.height;

                    if (originalWidth <= 0 || originalHeight <= 0) {
                        throw new Error('原始图片尺寸无效。请确保图片已正确加载。');
                    }

                    // 创建用于 OpenCV 处理的原始尺寸图片画布
                    tempCanvas = document.createElement('canvas');
                    tempCtx = tempCanvas.getContext('2d', { willReadFrequently: true });
                    tempCanvas.width = originalWidth;
                    tempCanvas.height = originalHeight;
                    tempCtx.imageSmoothingEnabled = true;
                    tempCtx.imageSmoothingQuality = 'high';
                    tempCtx.drawImage(originalImageObject, 0, 0, originalWidth, originalHeight);

                    // 创建用于 OpenCV 处理的原始尺寸遮罩画布
                    // 将当前显示尺寸的 maskCanvas 内容绘制到原始尺寸的 tempMaskCanvas 上
                    tempMaskCanvas = document.createElement('canvas');
                    tempMaskCtx = tempMaskCanvas.getContext('2d', { willReadFrequently: true });
                    tempMaskCanvas.width = originalWidth;
                    tempMaskCanvas.height = originalHeight;
                    // 关键：将显示尺寸的 maskCanvas 缩放绘制到原始尺寸的遮罩画布
                    tempMaskCtx.drawImage(maskCanvas, 0, 0, originalWidth, originalHeight);

                    console.log(`Original image dimensions (for processing): ${originalWidth}x${originalHeight}`);
                    console.log(`tempCanvas actual dimensions: ${tempCanvas.width}x${tempCanvas.height}`);
                    console.log(`tempMaskCanvas actual dimensions: ${tempMaskCanvas.width}x${tempMaskCanvas.height}`);
                    
                    // 延迟 OpenCV 操作，确保 Canvas 渲染完成
                    setTimeout(() => {
                        try {
                            // 再次验证临时画布是否有像素数据 (在 setTimeout 内部执行，确保 Canvas 已渲染)
                            const checkTempCanvasData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height).data;
                            console.log('DEBUG: tempCanvas pixel data length (after timeout):', checkTempCanvasData.length);
                            console.log('DEBUG: tempCanvas all pixels zero (after timeout):', checkTempCanvasData.every(pixel => pixel === 0));
                            if (checkTempCanvasData.length === 0 || checkTempCanvasData.every(pixel => pixel === 0)) {
                                throw new Error('临时图片画布无有效像素数据 (setTimeout 后)。请尝试刷新页面或使用其他图片。');
                            }
                            
                            const checkTempMaskCanvasData = tempMaskCtx.getImageData(0, 0, tempMaskCanvas.width, tempMaskCanvas.height).data;
                            console.log('DEBUG: tempMaskCanvas pixel data length (after timeout):', checkTempMaskCanvasData.length);
                            console.log('DEBUG: tempMaskCanvas all pixels zero (after timeout):', checkTempMaskCanvasData.every(pixel => pixel === 0));
                            // 遮罩可能全是0（透明），但至少尺寸要对
                            if (tempMaskCanvas.width * tempMaskCanvas.height === 0) {
                                throw new Error('临时遮罩画布尺寸无效 (setTimeout 后)。');
                            }

                            // 直接从 ImageData 创建 cv.Mat，避免 cv.imread 的潜在问题
                            let src_rgba = new cv.Mat(tempCanvas.height, tempCanvas.width, cv.CV_8UC4);
                            src_rgba.data.set(checkTempCanvasData);

                            let mask_rgba = new cv.Mat(tempMaskCanvas.height, tempMaskCanvas.width, cv.CV_8UC4);
                            mask_rgba.data.set(checkTempMaskCanvasData);

                            if (src_rgba.empty()) {
                                throw new Error('无法从临时图片画布像素数据创建源图像 Mat。');
                            }
                            if (mask_rgba.empty()) {
                                throw new Error('无法从临时遮罩画布像素数据创建遮罩图像 Mat。');
                            }

                            // 定义 Mat 变量
                            src = null; // will be src_rgba converted to RGB
                            mask = null; // will be mask_rgba converted to gray
                            dst = new cv.Mat();
                            gray = null; 
                            maskGray = new cv.Mat();
                            binaryMask = new cv.Mat();
                            dilatedMask = new cv.Mat();
                            kernel = null; // Initialise kernel here as well

                            // Convert src_rgba to RGB for inpaint
                            src = new cv.Mat();
                            cv.cvtColor(src_rgba, src, cv.COLOR_RGBA2RGB);
                            
                            // Validate src Mat
                            if (src.empty() || src.type() !== cv.CV_8UC3) {
                                throw new Error(`转换后的源图像 Mat 无效或类型不匹配。Type: ${src.type()}, Channels: ${src.channels()}`);
                            }

                            // 转换为灰度图 (mask_rgba to maskGray)
                            cv.cvtColor(mask_rgba, maskGray, cv.COLOR_RGBA2GRAY, 0);
                            
                            // Validate maskGray Mat
                            if (maskGray.empty() || maskGray.type() !== cv.CV_8UC1) {
                                throw new Error(`转换后的遮罩灰度图 Mat 无效或类型不匹配。Type: ${maskGray.type()}, Channels: ${maskGray.channels()}`);
                            }
                            
                            // 二值化遮罩
                            cv.threshold(maskGray, binaryMask, 1, 255, cv.THRESH_BINARY);
                            
                            // 扩展遮罩区域
                            kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(5, 5)); // 稍微增大核
                            cv.dilate(binaryMask, dilatedMask, kernel, new cv.Point(-1, -1), 2); // 增加迭代次数
                            
                            // Validate dilatedMask Mat content before inpaint
                            if (dilatedMask.empty() || dilatedMask.cols === 0 || dilatedMask.rows === 0) {
                                throw new Error(`膨胀后的遮罩 Mat 为空或尺寸无效。`);
                            }
                            const dilatedMaskData = new Uint8Array(dilatedMask.data);
                            const hasDilatedMaskPixels = dilatedMaskData.some(pixel => pixel > 0);
                            if (!hasDilatedMaskPixels) {
                                // 如果没有有效遮罩像素，表示没有标记水印，或者标记太小被膨胀没了
                                throw new Error(`膨胀后的遮罩 Mat 无有效像素，可能未正确标记水印区域或标记过于微小。`);
                            }
                            const allDilatedMaskPixelsFull = dilatedMaskData.every(pixel => pixel === 255);
                            if (allDilatedMaskPixelsFull) {
                                throw new Error(`膨胀后的遮罩 Mat 填充了整个图像，无法处理。请只标记水印区域。`);
                            }

                            // Validate dilatedMask Mat type
                            if (dilatedMask.type() !== cv.CV_8UC1) {
                                throw new Error(`膨胀后的遮罩 Mat 类型不匹配。Expected CV_8UC1, Got: ${dilatedMask.type()}`);
                            }
                            
                            // 使用改进的修复算法
                            cv.inpaint(src, dilatedMask, dst, 3, cv.INPAINT_TELEA);
                            
                            // 创建高清结果图（保存但不显示）
                            const hdResultCanvas = document.createElement('canvas');
                            hdResultCanvas.width = originalWidth;
                            hdResultCanvas.height = originalHeight;
                            cv.imshow(hdResultCanvas, dst);

                            // 存储高清结果以供下载使用
                            window.hdResultImage = hdResultCanvas.toDataURL('image/png');

                            // 为预览图定义最大尺寸
                            const MAX_PREVIEW_DIMENSION = 800; // 预览图最长边不超过800px
                            let previewWidth, previewHeight;
                            const originalAspect = originalWidth / originalHeight;
                            
                            if (originalWidth > originalHeight) {
                                previewWidth = MAX_PREVIEW_DIMENSION;
                                previewHeight = Math.floor(previewWidth / originalAspect);
                            } else {
                                previewHeight = MAX_PREVIEW_DIMENSION;
                                previewWidth = Math.floor(previewHeight * originalAspect);
                            }

                            // 设置结果画布为计算出的预览尺寸
                            resultCanvas.width = previewWidth;
                            resultCanvas.height = previewHeight;
                            
                            // 1. 先将高清结果绘制到预览画布上
                            resultCtx.drawImage(hdResultCanvas, 0, 0, originalWidth, originalHeight, 0, 0, previewWidth, previewHeight);
                            
                            // 2. 从预览画布生成低质量的JPEG数据，并用它来覆盖画布，防止右键保存高清图
                            const previewJpegUrl = resultCanvas.toDataURL('image/jpeg', 0.7);
                            const previewImage = new Image();
                            
                            previewImage.onload = () => {
                                // 3. 加载完成后，用这个低质量的图片覆盖画布的原始内容
                                resultCtx.clearRect(0, 0, previewWidth, previewHeight);
                                resultCtx.drawImage(previewImage, 0, 0, previewWidth, previewHeight);

                                // 4. 更新UI并结束处理流程
                                const resultContainer = resultCanvas.parentElement;
                                resultCanvas.style.width = '100%';
                                resultCanvas.style.height = '100%';
                                resultCanvas.style.objectFit = 'contain';

                                hdResultCanvas.remove();
                                resolve();
                            };
                            
                            previewImage.onerror = reject; // 如果图片加载失败，则拒绝Promise
                            previewImage.src = previewJpegUrl;
                        } catch (innerError) {
                            reject(innerError);
                        } finally {
                            // 清理内存
                            if (src_rgba) src_rgba.delete(); 
                            if (mask_rgba) mask_rgba.delete(); 
                            if (src) src.delete();
                            if (mask) mask.delete(); 
                            if (dst) dst.delete();
                            if (gray) gray.delete();
                            if (maskGray) maskGray.delete();
                            if (binaryMask) binaryMask.delete();
                            if (dilatedMask) dilatedMask.delete();
                            if (kernel) kernel.delete();

                            // 清理临时画布
                            if (tempCanvas) tempCanvas.remove();
                            if (tempMaskCanvas) tempMaskCanvas.remove();
                        }
                    }, 1000); // 延迟 1000 毫秒，等待 Canvas 渲染完成
                } catch(e) {
                    console.error("图片处理初始化或画布错误:", e);
                    reject(e);
                }
            }).then(() => {
                // 更新UI
                loadingOverlay.classList.add('hidden');
                editContainer.classList.remove('hidden'); 
                emptyResult.classList.add('hidden');
                resultContainer.classList.remove('hidden');
                processBtn.classList.add('hidden');
                
                // 计算处理质量分数（基于遮罩区域大小）
                const maskArea = maskData.data.filter(pixel => pixel > 0).length;
                const totalArea = maskData.data.length;
                const maskRatio = totalArea > 0 ? maskArea / totalArea : 0; // 避免除以零
                const score = Math.min(99, Math.max(85, Math.floor(95 - (maskRatio * 100))));
                
                qualityScore.textContent = `${score}%`;
                qualityBar.style.width = `${score}%`;

                // 记录图片处理次数
                recordImageProcessed();

                // DEBUG: Check imageCanvas content after processing
                const imageCanvasDebugCtx = imageCanvas.getContext('2d');
                const imageDataAfterProcess = imageCanvasDebugCtx.getImageData(0, 0, imageCanvas.width, imageCanvas.height);
                console.log('DEBUG: imageCanvas pixel data length after processing:', imageDataAfterProcess.data.length);
                console.log('DEBUG: imageCanvas all pixels zero after processing:', imageDataAfterProcess.data.every(pixel => pixel === 0));

            }).catch((error) => {
                console.error("图片处理失败:", error);
                alert(`图片处理失败。错误: ${error.message || error}。请确保标记的水印区域有效。处理大图可能需要更长时间。如果问题持续存在，请尝试使用较小尺寸的图片或刷新页面后重试。`);
                loadingOverlay.classList.add('hidden');
            });
        }

            function downloadResult(type) {
                const link = document.createElement('a');
                const filename = currentFiles[activeFileIndex].name.replace(/\.[^/.]+$/, "");

                if (type === 'full') {
                    // 检查用户是否有权限下载高清版本
                    if (checkUserPermission('downloadHD')) {
                        // 使用存储的高清图像数据而非从resultCanvas获取
                        link.download = `${filename}-removed-hd.png`;
                        link.href = window.hdResultImage; // 使用存储的高清图像数据
                        link.click();
                        
                        // 记录一次高清图片导出
                        recordHDImageExported();
                    } else {
                        // 显示会员级别信息和购买选项
                        const user = JSON.parse(localStorage.getItem('loggedInUser'));
                        const membership = getUserMembershipLevel(user);
                        
                        // 检查是否已达到今日高清导出限额
                        const hdExportedToday = parseInt(localStorage.getItem('hdExportedToday') || '0');
                        if (membership.canDownloadHD && hdExportedToday >= membership.hdExportLimit) {
                            // 已达到今日高清导出限额
                            alert(i18next.t('alert_hd_export_limit_reached', { 
                                count: hdExportedToday, 
                                limit: membership.hdExportLimit
                            }));
                        } else {
                            // 无高清导出权限
                            alert(i18next.t('alert_purchase_premium', {
                                membershipName: i18next.t(membership.name)
                            }));
                        }
                    }
                } else { // 'preview'
                    // 下载预览图，使用较低质量的JPEG格式以减小文件大小
                    link.download = `${filename}-removed-preview.jpeg`;
                    link.href = resultCanvas.toDataURL('image/jpeg', 0.7); // 使用JPEG和70%质量
                    link.click();
                    
                    // 记录一次图片处理（仅作统计）
                    recordImageProcessed();
                }
            }
            
            function resetToInitial() {
                currentFiles = [];
                activeFileIndex = -1;
                maskHistory = [];
                historyIndex = [];
                drawingEnabled = false;
                // isPremiumUser = false; // 重置时是否重置付费状态？根据需求决定是否取消注释
                originalImageObject = null; // 重置时清空原始图片对象
                window.hdResultImage = null; // 清除存储的高清图像数据

                uploadContainer.classList.remove('hidden');
                editContainer.classList.add('hidden');
                resultContainer.classList.add('hidden');
                emptyResult.classList.remove('hidden');
                
                processBtn.classList.remove('hidden');
                processBtn.disabled = true;

                // 确保标记水印按钮处于未激活状态
                drawMaskBtn.classList.remove('bg-indigo-600', 'text-white');
                drawMaskBtn.classList.add('bg-gray-200', 'text-gray-700');
                maskCanvas.classList.remove('mask-drawing');
                maskCanvas.style.pointerEvents = 'none';

                imageCtx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
                maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
                resultCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
                
                fileListContainer.classList.add('hidden');
                fileList.innerHTML = '';

                // 重置文件输入
                if(fileInput) {
                    fileInput.value = '';
                }
            }

            function purchase(plan) {
                const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

                // 1. 检查用户是否登录
                if (!loggedInUser) {
                    alert(i18next.t('alert_login_to_purchase', '请先登录再进行购买'));
                    return;
                }

                // 调用Creem支付处理函数
                handleCreemPayment(plan);
            }
            
            // 修改 OpenCV 加载检查
            const opencvReady = () => {
                if (typeof cv !== 'undefined' && cv.Mat) {
                    console.log('OpenCV.js 已加载完成');
                    initialize();
            } else {
                    console.log('等待 OpenCV.js 加载...');
                    setTimeout(opencvReady, 100);
                }
            }

            // 确保 OpenCV 加载完成后再初始化
            if (document.readyState === 'complete') {
                opencvReady();
            } else {
                window.addEventListener('load', opencvReady);
            }

            // 为自定义 Google 登录按钮添加点击事件
            const customGoogleLoginButton = document.getElementById('custom-google-login-button');
            if (customGoogleLoginButton) {
                customGoogleLoginButton.addEventListener('click', () => {
                    if (client) {
                        client.requestCode(); // 触发授权码请求
                    } else {
                        console.error("Google OAuth2 CodeClient 未初始化。");
                    }
                });
            }
        });

        // 在 GSI 库加载后初始化 CodeClient
        window.onload = function () {
            // 立即检查和更新登录状态
            setTimeout(() => {
                console.log("初始化登录状态...");
                // 检查用户登录状态并进行相应的UI更新
                updateLoginStatusUI();
                
                // 检查支付状态
                checkPaymentStatus();
                
                // 确保下拉菜单事件绑定
                const userIcon = document.getElementById('user-icon');
                const userName = document.getElementById('user-name');
                const membershipDropdown = document.getElementById('membership-dropdown');
                const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
                
                if (loggedInUser && userIcon && !userIcon.hasAttribute('data-has-click-listener')) {
                    console.log("重新绑定用户图标点击事件...");
                    userIcon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        console.log("用户图标被点击（onload）");
                        toggleDropdown();
                    });
                    userIcon.setAttribute('data-has-click-listener', 'true');
                }
                
                if (loggedInUser && userName && !userName.hasAttribute('data-has-click-listener')) {
                    console.log("重新绑定用户名点击事件...");
                    userName.addEventListener('click', function(e) {
                        e.stopPropagation();
                        console.log("用户名被点击（onload）");
                        toggleDropdown();
                    });
                    userName.setAttribute('data-has-click-listener', 'true');
                }
                
                // 添加点击其他区域关闭下拉菜单的事件
                if (!document.body.hasAttribute('data-has-click-listener')) {
                    console.log("为body添加点击事件以关闭下拉菜单（onload）");
                    document.body.addEventListener('click', function() {
                        console.log("点击了页面其他区域");
                        if (membershipDropdown && !membershipDropdown.classList.contains('hidden')) {
                            console.log("关闭下拉菜单");
                            membershipDropdown.classList.add('hidden');
                        }
                    });
                    document.body.setAttribute('data-has-click-listener', 'true');
                }
            }, 500);
            
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                client = google.accounts.oauth2.initCodeClient({
                    client_id: '148741481582-umpmj8lom2gihge3em97tuc70hf9m9pg.apps.googleusercontent.com', // 您的 Google Client ID
                    scope: 'https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email', // 请求用户资料和邮箱
                    ux_mode: 'popup', // 使用弹出窗口模式
                    callback: handleAuthCodeResponse, // 授权码回调函数
                    // redirect_uri 不需要在此处显式设置，因为它在弹出模式下由 GSI 自动处理
                    // 确保您的 Google Cloud 控制台已将 'http://localhost:8000' 添加为授权的 JavaScript 来源
                });
            } else {
                console.error("Google Identity Services (GSI) OAuth2 库未加载或未正确初始化。");
            }
        };

        // 查看localStorage中是否有用户数据
        JSON.parse(localStorage.getItem('loggedInUser'))

        // 查看登录按钮是否可见
        document.getElementById('google-login-item').classList.contains('hidden')

        // 查看用户状态区域是否可见
        document.getElementById('user-status-item').classList.contains('hidden')

        // 添加调试功能，直接显示下拉菜单
        function showDropdown() {
            const membershipDropdown = document.getElementById('membership-dropdown');
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            
            if (membershipDropdown) {
                // 先显示下拉菜单
                membershipDropdown.classList.remove('hidden');
                console.log("已显示下拉菜单");
                
                // 更新会员信息
                if (loggedInUser) {
                    updateMembershipInfo(loggedInUser, membershipDropdown);
                    console.log("已更新会员信息");
                }
                
                return "下拉菜单已显示";
            } else {
                console.error("未找到会员下拉菜单元素");
                return "错误：未找到下拉菜单元素";
            }
        }

        // 更新会员信息显示
        function updateMembershipInfo(user, dropdown) {
            if (!user || !dropdown) {
                console.error("更新会员信息失败：无用户信息或下拉菜单元素");
                return;
            }
            
            console.log("开始更新会员信息...");
            
            const membershipRemaining = document.getElementById('membership-remaining');
            const membershipLevel = document.getElementById('membership-level');
            const processedToday = document.getElementById('processed-today');
            
            if (!membershipRemaining || !membershipLevel || !processedToday) {
                console.error("下拉菜单内的元素未找到，请检查HTML结构");
                return;
            }
            
            console.log("所有元素已找到，正在设置内容");
            
            // 更新剩余会员时间
            if (user.membershipEnd) {
                const endDate = new Date(user.membershipEnd);
                const remainingDays = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));
                if (remainingDays > 0) {
                    membershipRemaining.textContent = i18next.t('membership_days_remaining', { count: remainingDays });
                } else {
                    membershipRemaining.textContent = i18next.t('membership_expired');
                }
            } else {
                membershipRemaining.textContent = i18next.t('membership_free_user', '免费用户');
            }
            
            // 更新会员等级
            const membership = getUserMembershipLevel(user);
            // 对会员级别名称也应用国际化
            if (membership && membership.name) {
                membershipLevel.textContent = i18next.t(membership.name);
            } else {
                membershipLevel.textContent = i18next.t('membership_free_user');
            }
            
            // 更新今日高清导出数量
            const today = new Date().toISOString().split('T')[0];
            const lastHDExportDate = localStorage.getItem('lastHDExportDate');
            const hdExportLimit = membership.hdExportLimit;
            const limitDisplay = hdExportLimit === Infinity ? i18next.t('unlimited', '无限制') : hdExportLimit;
            
            let countToday = 0;
            if (lastHDExportDate === today) {
                countToday = parseInt(localStorage.getItem('hdExportedToday') || '0');
            }
            
            processedToday.textContent = `${countToday}/${limitDisplay}`;
            if (hdExportLimit !== Infinity) {
                processedToday.textContent += i18next.t('processed_unit', '张');
            }
            
            console.log("会员信息更新完成");
        }

        // 添加调试功能，检查登录状态
        function checkLoginStatus() {
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            const googleLoginItem = document.getElementById('google-login-item');
            const userStatusItem = document.getElementById('user-status-item');
            const userStatusContainer = document.getElementById('user-status-container');
            
            console.log("===== 登录状态检查 =====");
            console.log("用户数据:", loggedInUser);
            console.log("登录按钮容器存在:", !!googleLoginItem);
            console.log("用户状态容器存在:", !!userStatusItem);
            console.log("用户状态内容容器存在:", !!userStatusContainer);
            
            if (googleLoginItem) {
                console.log("登录按钮是否隐藏:", googleLoginItem.classList.contains('hidden'));
            }
            
            if (userStatusItem) {
                console.log("用户状态是否隐藏:", userStatusItem.classList.contains('hidden'));
            }
            
            // 检查用户图标和用户名
            const userIcon = document.getElementById('user-icon');
            const userName = document.getElementById('user-name');
            console.log("用户图标元素存在:", !!userIcon);
            console.log("用户名元素存在:", !!userName);
            
            if (userName) {
                console.log("用户名显示内容:", userName.textContent);
            }
            
            // 检查各容器内容
            console.log("用户状态容器HTML:", userStatusItem ? userStatusItem.innerHTML : "不存在");
            
            return "登录状态检查完成，请查看控制台";
        }
    </script>
</body>
</html>
    